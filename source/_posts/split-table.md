title: 分库分表中间件
date: 2017-03-09 23:18:56
tags:
---

### 一、为什么分库分表
#### 服务器易横向扩展
在高并发的场景下，服务器可以很容易的通过增加机器的方式来加强服务的承载能力。当并发量达到一定程度时，数据库连接池往往成为进一步提升服务承载能力的瓶颈。
#### 数据库横向扩展易导致数据一致性问题
数据库也可以通过增加机器的方式来进行扩容，但由于各节点数据同步存在延时，容易导致数据一致性问题。并且单表数据量过大时即使增加机器也会出现单次查询过慢的情况。

分库分表正是为了解决这一问题。

### 二、常用分库分表方式

#### 读写分离
这里把读写分离也作为一种分库分表方式。现在数据库一般都有从库来进行热备，读写分离是指在主库进行写操作，在从库进行读操作，这样不仅能利用闲置资源，同时也能减轻主库压力。
#### 垂直分表
将一张数据表按列拆分为多个表。可以减少表中每行的数据量大小，这样每个数据页可以加载更多行数据，从而提高查询效率。
#### 垂直分库
将一个库中的数据表按不同业务拆分到不同库中，能减轻每个库的压力。
#### 水平分表
将一个表中的数据根据某种规则按行拆分到不同的表中，这些表的表结构完全相同。水平分表能减少每个表中的数据量，提高查询效率。
#### 水平分库
将一个表中的数据根据某种规则按行拆分到不同的表中，并且这些表的表名和表结构完全相同，但每张表都在不同的库中。水平分库不仅有水平分表的优点，同时因为每个表都在独立的库中，因此可以有更多连接数。当然并不是说水平分库就一定比水平分表好，比如需要事务操作时就更适合用水平分表。

上述几种方式中，垂直分库分表一般要影响业务，我认为垂直划分的方式除了对数据库扩容，更大的好处是将数据拆分后将不同业务在数据库层面进行了解耦，后续能够支持服务化拆分。
水平分库分表一般不影响业务，所以能够通过分库分表中间件来进行。

### 三、分库分表中间件分类
#### 客户端方案
	Oceanus、Sharding-JDBC、Cobar-Client
客户端方案又分为基于JDBC协议和基于ORM框架,上面三个中间件中，Cobar-Client是基于ORM框架，另两种都是基于JDBC协议。
#### 中间层方案
	Cobar、heisenberg
基于mysql c-s协议实现，相比于客户端方案，中间层方案在客户端使用成本更低，但中间层代理服务器一旦出现问题会影响所有应用，并且数据库升级时需要考虑兼容性问题。
### 四、分库分表中间件组成模块
客户端方案和中间层方案除了协议层不同外其他模块都基本相同，大致分为以下模块
#### 分片规则
用于配置分库分表规则
#### 协议重写
重写相关协议，例如基于JDBC协议的分库分表中间件需要重写DateSource、Connection、ResultSet等接口
#### sql解析
用来解析sql语句中的关键字
#### sql改写
主要分为两个部分，一是将sql中的逻辑表明替换为真实表明；二是将sql解析结果中一些在分片环境下不正确的功能修复，下面是一个常被引用的例子：

	在分片场景下，(avg1+avg2+avg3)/3计算平均值结果并不正确，要修改为（sum1+sum2+sum3）/(count1+count2+count3),这就需要对原有sql解析结果进行修正，对每个分片取sum和count
#### sql路由
根据分片规则中的配置将sql请求路由至正确的数据源
#### sql执行
将分片到各个数据库的sql批量执行
#### 结果归并
将各分片的sql执行结果归并成一个结果
### 四、分库分表场景需要注意的问题
#### 1.where条件尽量带有分片字段，减少sql改写和结果归并的开销
#### 2.where条件不带分片字段时慎重使用聚集函数与limit分页
#### 3.尽量避免使用分布式事务
	


